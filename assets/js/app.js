// Generated by CoffeeScript 1.3.3
(function() {
  var Controller, REGISTER, Station, StationsCollection, Train, TrainCollection, bb, emptyList, init, mainView, pause, resume, selector, start, stop, trainItem, trainList,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    _this = this;

  bb = (function(_super) {

    __extends(bb, _super);

    function bb() {
      return bb.__super__.constructor.apply(this, arguments);
    }

    return bb;

  })(Backbone);

  bb.Router = (function(_super) {

    __extends(Router, _super);

    function Router() {
      this.navigate = __bind(this.navigate, this);
      return Router.__super__.constructor.apply(this, arguments);
    }

    Router.prototype.navigate = function(str, options) {
      if (options === void 0) {
        options = {};
      }
      options.trigger = true;
      return Backbone.Router.prototype.navigate.call(this, str, options);
    };

    return Router;

  })(Backbone.Router);

  bb.history = Backbone.history;

  REGISTER = {};

  init = function() {
    var hash;
    REGISTER.router = new Controller;
    Backbone.history.start({
      pushState: true,
      sessionStorage: true,
      root: window.location.pathname
    });
    hash = Backbone.history.getHash();
    if (hash === "") {
      return console.debug("change the fragment  of " + hash);
    } else {
      return console.debug("Already a fragment of " + hash);
    }
  };

  start = function() {
    return REGISTER.router.startTimer();
  };

  stop = function() {
    return REGISTER.router.stopTimer();
  };

  pause = function() {
    return REGISTER.router.stopTimer();
  };

  resume = function() {
    return REGISTER.router.startTimer();
  };

  $(document).ready(function() {
    init();
    return start();
  });

  Controller = (function(_super) {

    __extends(Controller, _super);

    function Controller() {
      this.emptySelection = __bind(this.emptySelection, this);

      this.trainsFrom = __bind(this.trainsFrom, this);

      this.trainsFromTo = __bind(this.trainsFromTo, this);

      this._updateTimerRefs = __bind(this._updateTimerRefs, this);

      this.stopTimer = __bind(this.stopTimer, this);

      this.startTimer = __bind(this.startTimer, this);
      return Controller.__super__.constructor.apply(this, arguments);
    }

    Controller.prototype.initialize = function() {
      return this.view = new mainView;
    };

    Controller.prototype.startTimer = function() {
      if (!(this.trains === void 0 || null)) {
        this.trains.stop();
      }
      if (!(this.trains === void 0 || null)) {
        this.trains.start();
      }
      return this.timerStatus = true;
    };

    Controller.prototype.stopTimer = function() {
      if (!(this.trains === void 0 || null)) {
        this.trains.stop();
      }
      return this.timerStatus = false;
    };

    Controller.prototype._updateTimerRefs = function(trains) {
      if (this.timerStatus === true) {
        console.debug('restart timer');
        this.stopTimer();
        this.trains = trains;
      } else {
        console.debug('timer never started');
        this.trains = trains;
      }
      return this.startTimer();
    };

    Controller.prototype.routes = {
      '': 'emptySelection',
      'trains/from/:from/to/:to': 'trainsFromTo',
      'trains/from/:from': 'trainsFrom'
    };

    Controller.prototype.trainsFromTo = function(from, to) {
      var trains;
      console.debug('from to');
      from = from.toUpperCase();
      to = to.toUpperCase();
      console.debug('start');
      this.stopTimer();
      trains = new TrainCollection(null, {
        from: from,
        to: to
      });
      this.view.trainList.setTrainList(trains);
      this.view.selector.setTrainFromTo(from, to);
      this.view.trainList.refresh();
      return this._updateTimerRefs(trains);
    };

    Controller.prototype.trainsFrom = function(from) {
      var trains;
      console.debug('from only');
      from = from.toUpperCase();
      this.stopTimer();
      trains = new TrainCollection(null, {
        from: from
      });
      this.view.trainList.setTrainList(trains);
      this.view.selector.setTrainFrom(from);
      this.view.trainList.refresh();
      return this._updateTimerRefs(trains);
    };

    Controller.prototype.emptySelection = function() {
      this.view.trainList.setTrainList();
      return this.view.trainList.refresh();
    };

    return Controller;

  })(bb.Router);

  Station = (function(_super) {

    __extends(Station, _super);

    function Station() {
      return Station.__super__.constructor.apply(this, arguments);
    }

    Station.prototype.defaults = {
      code: "code",
      name: "name",
      location: {}
    };

    return Station;

  })(bb.Model);

  StationsCollection = (function(_super) {

    __extends(StationsCollection, _super);

    function StationsCollection() {
      this.comparator = __bind(this.comparator, this);

      this.parse = __bind(this.parse, this);

      this.url = __bind(this.url, this);
      return StationsCollection.__super__.constructor.apply(this, arguments);
    }

    StationsCollection.prototype.model = Station;

    StationsCollection.prototype.initialize = function(n, options) {
      return console.debug('initialize stations collection');
    };

    StationsCollection.prototype.url = function() {
      return "https://www.riper.fr/api/stif/stations";
    };

    StationsCollection.prototype.parse = function(response, xhr) {
      if (xhr.status === 200 && response.status === true) {
        return response.response;
      } else {
        console.debug('Error in response from server with parameters ' + ("" + this.from + "/" + this.to));
        return [];
      }
    };

    StationsCollection.prototype.comparator = function(Station1, Station2) {
      if (Station1.get('name') === Station2.get('name')) {
        return 0;
      }
      if (Station1.get('name') > Station2.get('name')) {
        return 1;
      } else {
        return -1;
      }
    };

    return StationsCollection;

  })(Backbone.Collection);

  Train = (function(_super) {

    __extends(Train, _super);

    function Train() {
      return Train.__super__.constructor.apply(this, arguments);
    }

    Train.prototype.defaults = {
      name: "name",
      mission: "Mission code",
      date: "dateTimeObject",
      lane: "plateform"
    };

    return Train;

  })(bb.Model);

  TrainCollection = (function(_super) {

    __extends(TrainCollection, _super);

    function TrainCollection() {
      this.updateTrainList = __bind(this.updateTrainList, this);

      this.stop = __bind(this.stop, this);

      this.start = __bind(this.start, this);

      this.cleanup = __bind(this.cleanup, this);

      this.parse = __bind(this.parse, this);

      this.url = __bind(this.url, this);
      return TrainCollection.__super__.constructor.apply(this, arguments);
    }

    TrainCollection.prototype.model = Train;

    TrainCollection.prototype.initialize = function(n, options) {
      console.debug('initialize collection');
      if (options !== void 0) {
        if (options.from !== void 0) {
          this.from = options.from;
        }
        if (options.to !== void 0) {
          return this.to = options.to;
        }
      }
    };

    TrainCollection.prototype.url = function() {
      if (this.to !== void 0) {
        return "https://www.riper.fr/api/stif/trains/from/" + this.from + "/to/" + this.to;
      } else {
        return "https://www.riper.fr/api/stif/trains/from/" + this.from;
      }
    };

    TrainCollection.prototype.parse = function(response, xhr) {
      if (xhr.status === 200 && response.status === true) {
        return response.response;
      } else {
        console.debug('Error in response from server with parameters ' + ("" + this.from + "/" + this.to));
        return [];
      }
    };

    TrainCollection.prototype.cleanup = function(ids) {
      var _this = this;
      return this.each(function(train) {
        if (_.indexOf(ids, train.get('id')) === -1) {
          console.debug("Train is outdated " + (train.get('trainMissionCode')));
          return _this.remove(train);
        }
      });
    };

    TrainCollection.prototype.start = function() {
      if (this.timer) {
        clearInterval(this.timer);
      }
      this.updateTrainList();
      return this.timer = setInterval(this.updateTrainList, 2000);
    };

    TrainCollection.prototype.stop = function() {
      if (this.timer) {
        return clearInterval(this.timer);
      }
    };

    TrainCollection.prototype.updateTrainList = function() {
      var _this = this;
      if (this.working !== true) {
        this.working = true;
        return this.fetch({
          add: true,
          success: function(n, response) {
            var ids;
            _this.working = false;
            ids = _.pluck(response.response, 'id');
            return _this.cleanup(ids);
          },
          error: function(n, reponse) {
            return _this.working = false;
          }
        });
      }
    };

    return TrainCollection;

  })(Backbone.Collection);

  emptyList = (function(_super) {

    __extends(emptyList, _super);

    function emptyList() {
      this.render = __bind(this.render, this);
      return emptyList.__super__.constructor.apply(this, arguments);
    }

    emptyList.prototype.template = _.template("Please make a selection");

    emptyList.prototype.initialize = function() {
      return this.render();
    };

    emptyList.prototype.render = function() {
      return this.$el.html(this.template({}));
    };

    return emptyList;

  })(bb.View);

  mainView = (function(_super) {

    __extends(mainView, _super);

    function mainView() {
      return mainView.__super__.constructor.apply(this, arguments);
    }

    mainView.prototype.el = $('body');

    mainView.prototype.template = _.template("<div class=\"selector\"></div>\n<div class=\"list\"></div>");

    mainView.prototype.initialize = function() {
      _.bindAll(this);
      return this.render();
    };

    mainView.prototype.render = function() {
      this.trainList = new trainList();
      this.selector = new selector();
      $(this.el).html(this.template({}));
      this.$('.list').append(this.trainList.el);
      return this.$('.selector').append(this.selector.el);
    };

    return mainView;

  })(bb.View);

  selector = (function(_super) {

    __extends(selector, _super);

    function selector() {
      this.render = __bind(this.render, this);

      this.selectChanged = __bind(this.selectChanged, this);

      this.setTrainFromTo = __bind(this.setTrainFromTo, this);

      this.setTrainTo = __bind(this.setTrainTo, this);

      this.setTrainFrom = __bind(this.setTrainFrom, this);

      this.refreshStations = __bind(this.refreshStations, this);

      this.appendStation = __bind(this.appendStation, this);

      this.connect = __bind(this.connect, this);
      return selector.__super__.constructor.apply(this, arguments);
    }

    selector.prototype.template = _.template("Prochains départs de <select class=\"selectFrom\"></select> à <select class=\"selectTo\"></select>");

    selector.prototype.initialize = function() {
      this.stations = new StationsCollection();
      this.connect();
      this.render();
      return this.stations.fetch();
    };

    selector.prototype.events = {
      'change select': 'selectChanged'
    };

    selector.prototype.connect = function() {
      if (this.stations) {
        this.stations.unbind('reset', this.refreshStations);
      }
      this.stations.bind('add', this.appendStation);
      return this.stations.bind('reset', this.refreshStations);
    };

    selector.prototype.appendStation = function(Station, collection) {
      var optionFrom, optionTo;
      console.debug('append stations');
      optionFrom = document.createElement('option');
      optionFrom.innerHTML = Station.get('name');
      optionFrom.value = Station.get('code');
      if (Station.get('code') === this.from) {
        $(optionFrom).attr("selected", "selected");
      }
      this.selectFrom.append(optionFrom);
      optionTo = document.createElement('option');
      optionTo.innerHTML = Station.get('name');
      optionTo.value = Station.get('code');
      if (Station.get('code') === this.to) {
        $(optionTo).attr("selected", "selected");
      }
      return this.selectTo.append(optionTo);
    };

    selector.prototype.refreshStations = function() {
      this.selectFrom.html('<option value="">Selectionez une gare</option>');
      this.selectTo.html('<option value="">Toutes direction</option>');
      return this.stations.each(this.appendStation);
    };

    selector.prototype.setTrainFrom = function(from) {
      this.from = from;
      return this.refreshStations();
    };

    selector.prototype.setTrainTo = function(to) {
      this.to = to;
      return this.refreshStations();
    };

    selector.prototype.setTrainFromTo = function(from, to) {
      this.from = from;
      this.to = to;
      return this.refreshStations();
    };

    selector.prototype.selectChanged = function() {
      if (this.selectFrom.val() === '') {
        return REGISTER.router.navigate('');
      } else if (this.selectTo.val() === '') {
        return REGISTER.router.navigate('trains/from/' + this.selectFrom.val());
      } else {
        return REGISTER.router.navigate('trains/from/' + this.selectFrom.val() + '/to/' + this.selectTo.val());
      }
    };

    selector.prototype.render = function() {
      this.$el.html(this.template({}));
      this.selectFrom = this.$('.selectFrom');
      this.selectTo = this.$('.selectTo');
      return this.refreshStations();
    };

    return selector;

  })(bb.View);

  trainItem = (function(_super) {

    __extends(trainItem, _super);

    function trainItem() {
      this.render = __bind(this.render, this);
      return trainItem.__super__.constructor.apply(this, arguments);
    }

    trainItem.prototype.model = Train;

    trainItem.prototype.nodeName = 'li';

    trainItem.prototype.template = _.template("Template Item Train {{trainMissionCode}} of {{trainHour}}");

    trainItem.prototype.initialize = function() {
      this.model.bind("change", this.render);
      return this.render();
    };

    trainItem.prototype.render = function() {
      console.debug("Render train named " + (this.model.get('trainMissionCode')) + " at " + (new Date().toString()));
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    };

    return trainItem;

  })(bb.View);

  trainList = (function(_super) {

    __extends(trainList, _super);

    function trainList() {
      this.removeTrain = __bind(this.removeTrain, this);

      this.appendTrain = __bind(this.appendTrain, this);

      this.refresh = __bind(this.refresh, this);
      return trainList.__super__.constructor.apply(this, arguments);
    }

    trainList.prototype.initialize = function() {
      _.bindAll(this);
      this.counter = 0;
      return this.render();
    };

    trainList.prototype.render = function() {
      var empty,
        _this = this;
      if (this.trainList) {
        $(this.el).append('<ul></ul>');
        return this.trainList.each(function(Train) {
          return _this.appendTrain(Train, _this.trainList);
        });
      } else {
        empty = new emptyList();
        return $(this.el).append(empty.el);
      }
    };

    trainList.prototype.refresh = function() {
      console.debug('reset view');
      $(this.el).html('');
      return this.render();
    };

    trainList.prototype.setTrainList = function(collection) {
      if (this.trainList) {
        this.trainList.unbind('add', this.appendTrain);
      }
      if (this.trainList) {
        this.trainList.unbind('remove', this.removeTrain);
      }
      if (this.trainList) {
        this.trainList.unbind('reset', this.refresh);
      }
      if (collection !== void 0) {
        this.trainList = collection;
        this.trainList.bind('add', this.appendTrain);
        this.trainList.bind('remove', this.removeTrain);
        return this.trainList.bind('reset', this.refresh);
      } else if (this.trainList) {
        return this.trainList = null;
      }
    };

    trainList.prototype.clearTrainList = function() {
      return this.trainList = null;
    };

    trainList.prototype.appendTrain = function(Train, collection) {
      if (Train.view === void 0) {
        Train.view = new trainItem({
          model: Train
        });
      }
      return $(this.el).find('ul').first().append(Train.view.el);
    };

    trainList.prototype.removeTrain = function(Train, collection) {
      return Train.view.remove();
    };

    return trainList;

  })(bb.View);

  trainList = (function(_super) {

    __extends(trainList, _super);

    function trainList() {
      this.removeTrain = __bind(this.removeTrain, this);

      this.appendTrain = __bind(this.appendTrain, this);

      this.refresh = __bind(this.refresh, this);
      return trainList.__super__.constructor.apply(this, arguments);
    }

    trainList.prototype.initialize = function() {
      _.bindAll(this);
      this.counter = 0;
      return this.render();
    };

    trainList.prototype.render = function() {
      var empty,
        _this = this;
      if (this.trainList) {
        $(this.el).append('<ul></ul>');
        return this.trainList.each(function(Train) {
          return _this.appendTrain(Train, _this.trainList);
        });
      } else {
        empty = new emptyList();
        return $(this.el).append(empty.el);
      }
    };

    trainList.prototype.refresh = function() {
      console.debug('reset view');
      $(this.el).html('');
      return this.render();
    };

    trainList.prototype.setTrainList = function(collection) {
      if (this.trainList) {
        this.trainList.unbind('add', this.appendTrain);
      }
      if (this.trainList) {
        this.trainList.unbind('remove', this.removeTrain);
      }
      if (this.trainList) {
        this.trainList.unbind('reset', this.refresh);
      }
      if (collection !== void 0) {
        this.trainList = collection;
        this.trainList.bind('add', this.appendTrain);
        this.trainList.bind('remove', this.removeTrain);
        return this.trainList.bind('reset', this.refresh);
      } else if (this.trainList) {
        return this.trainList = null;
      }
    };

    trainList.prototype.clearTrainList = function() {
      return this.trainList = null;
    };

    trainList.prototype.appendTrain = function(Train, collection) {
      if (Train.view === void 0) {
        Train.view = new trainItem({
          model: Train
        });
      }
      return $(this.el).find('ul').first().append(Train.view.el);
    };

    trainList.prototype.removeTrain = function(Train, collection) {
      return Train.view.remove();
    };

    return trainList;

  })(bb.View);

}).call(this);
